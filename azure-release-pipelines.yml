variables:
  imobiledevicenetBuild: 306
  imobiledevicenetPipeline: 1

jobs:
- job: nuget_deploy
  pool:
    vmImage: 'VS2017-Win2016'
  steps:
  - task: DownloadBuildArtifacts@0
    inputs:
      buildType: 'specific'
      project: 'imobiledevice-net'
      pipeline: $(imobiledevicenetPipeline)
      buildVersionToDownload: 'specific'
      buildId: $(imobiledevicenetBuild)
      downloadType: 'single'
      artifactName: 'imobiledevice-net'
      downloadPath: '$(System.ArtifactsDirectory)'
    displayName: 'Download imobiledevice-net artifacts'
  - task: NuGetCommand@2
    continueOnError: true
    inputs:
      command: push
      packagesToPush: '$(System.ArtifactsDirectory)\imobiledevice-net\iMobileDevice-net.*.nupkg'
      publishFeedCredentials: 'NuGet'
      nuGetFeedType: external

- job: deploy
  pool:
    vmImage: 'ubuntu-16.04'
  steps:
  - task: DownloadBuildArtifacts@0
    inputs:
      buildType: 'specific'
      project: 'imobiledevice-net'
      pipeline: $(imobiledevicenetPipeline)
      buildVersionToDownload: 'specific'
      buildId: $(imobiledevicenetBuild)
      downloadType: 'single'
      artifactName: 'imobiledevice-net'
      downloadPath: '$(System.ArtifactsDirectory)'
    displayName: 'Download imobiledevice-net artifacts'
  - task: DownloadBuildArtifacts@0
    inputs:
      buildType: 'specific'
      project: 'imobiledevice-net'
      pipeline: $(imobiledevicenetPipeline)
      buildVersionToDownload: 'specific'
      buildId: $(imobiledevicenetBuild)
      downloadType: 'single'
      artifactName: 'binaries'
      downloadPath: '$(System.ArtifactsDirectory)'
    displayName: 'Download binary artifacts'
  - script: |
      wget https://github.com/buildkite/github-release/releases/download/v1.0/github-release-linux-amd64 -O github-release
      chmod +x github-release

      sudo apt-get install -y libxml2-utils

      unzip $SYSTEM_ARTIFACTSDIRECTORY/imobiledevice-net/iMobileDevice-net.*.nupkg

      libplist_commit=`cat libplist.gitinfo/gitinfo | tail -n 1`
      libusbmuxd_commit=`cat libusbmuxd.gitinfo/gitinfo | tail -n 1`
      libimobiledevice_commit=`cat libimobiledevice.gitinfo/gitinfo | tail -n 1`
      usbmuxd_commit=`cat usbmuxd.gitinfo/gitinfo | tail -n 1`
      libideviceactivation_commit=`cat libideviceactivation.gitinfo/gitinfo | tail -n 1`
      imobiledevice_net_commit=$BUILD_SOURCEVERSION
      version_number=`xmllint --xpath 'Project/PropertyGroup/MobileDeviceDotNetNuGetVersion/text()' $SYSTEM_ARTIFACTSDIRECTORY/imobiledevice-net/Directory.Build.props`

      echo Releasing $version_number

      ./github-release "v$version_number" --commit "$libplist_commit" --github-repository "libimobiledevice-win32/libplist"
      ./github-release "v$version_number" --commit "$libusbmuxd_commit" --github-repository "libimobiledevice-win32/libusbmuxd"
      ./github-release "v$version_number" --commit "$libimobiledevice_commit" --github-repository "libimobiledevice-win32/libimobiledevice"
      ./github-release "v$version_number" --commit "$usbmuxd_commit" --github-repository "libimobiledevice-win32/usbmuxd"
      ./github-release "v$version_number" --commit "$libideviceactivation_commit" --github-repository "libimobiledevice-win32/libideviceactivation"
      ./github-release "v$version_number" $SYSTEM_ARTIFACTSDIRECTORY/imobiledevice-net/iMobileDevice-net.*.nupkg $SYSTEM_ARTIFACTSDIRECTORY/binaries/*.zip --commit "$imobiledevice_net_commit" --github-repository "libimobiledevice-win32/imobiledevice-net"
    displayName: Tag GitHub releases

# TODO: Publish NuGet package
# TODO: Publish usbmuxd Docker container